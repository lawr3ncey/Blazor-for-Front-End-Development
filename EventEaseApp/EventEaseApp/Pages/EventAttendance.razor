@page "/events/{id:int}/attendance"
@using EventEaseApp.Models
@using EventEaseApp.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject AttendanceService AttendanceService
@inject EventEaseApp.Services.UserSessionState UserSession

<PageTitle>Asistencia - EventEase</PageTitle>

<div class="container py-4">
    <h1>Asistencia - Evento @id</h1>

    @if (!UserSession.IsAuthenticated)
    {
        <div class="alert alert-info">No has iniciado sesión. Puedes iniciar sesión vía el formulario de registro o usando la acción de administrador.</div>
    }

    <p>Total inscritos: <strong>@AttendanceService.GetCount(id)</strong></p>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Registrado</th>
                <th>Presente</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in attendees)
            {
                <tr>
                    <td>@r.Name</td>
                    <td>@r.Email</td>
                    <td>@r.CreatedAt.ToLocalTime().ToString("g")</td>
                    <td>@(r.IsPresent ? "Sí" : "No")</td>
                    <td>
                        @if (!r.IsPresent)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => MarkPresent(r.Id)">Marcar presente</button>
                        }
                        else
                        {
                            <span class="text-success">Presente</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <div class="mt-3">
        <a class="btn btn-link" href="/events">Volver a eventos</a>
    </div>
</div>

@code {
    [Parameter]
    public int id { get; set; }

    private IEnumerable<AttendanceRecord> attendees = Enumerable.Empty<AttendanceRecord>();

    protected override void OnInitialized()
    {
        Load();
        base.OnInitialized();
    }

    private void Load()
    {
        attendees = AttendanceService.GetAttendees(id);
    }

    private void MarkPresent(Guid recordId)
    {
        AttendanceService.MarkPresent(recordId);
        Load();
        StateHasChanged();
    }
}
