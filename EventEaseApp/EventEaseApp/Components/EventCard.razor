@using System
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using EventEaseApp.Models
@inject NavigationManager NavigationManager
@inject EventEaseApp.Services.AttendanceService AttendanceService

<div class="card event-card mb-3" role="article" aria-label="Evento @Event?.Name">
	<div class="row g-0">
		<div class="col-4 d-none d-sm-block">
			<!-- Placeholder image - replace with real event image if available -->
			<img src="/images/event-placeholder.png" class="img-fluid rounded-start" alt="Imagen del evento" />
		</div>
		<div class="col">
			<div class="card-body">
				<h5 class="card-title">@Event?.Name</h5>
				<p class="card-text mb-1"><strong>Fecha:</strong> @Event?.Date.ToString("dd/MM/yyyy HH:mm")</p>
				<p class="card-text mb-2"><strong>Lugar:</strong> @Event?.Location</p>

				@if (validationErrors.Any())
				{
					<div class="alert alert-warning py-2" role="alert">
						<strong>Datos del evento incompletos:</strong>
						<ul class="mb-0">
							@foreach (var err in validationErrors)
							{
								<li>@err</li>
							}
						</ul>
					</div>
				}

				<div class="d-flex gap-2">
					<button class="btn btn-primary" @onclick="Register" disabled="@(!IsValid)">Registrarse</button>
					<button class="btn btn-outline-secondary" @onclick="ViewAttendance">Inscritos (@RegisteredCount)</button>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter]
	public Event? Event { get; set; }

	/// <summary>
	/// Optional callback invoked when user requests to register. If not provided, component navigates to /events/{id}/register.
	/// </summary>
	[Parameter]
	public EventCallback<Event> OnRegister { get; set; }

	private readonly List<string> validationErrors = new();

	private bool IsValid => !validationErrors.Any();

	protected override void OnParametersSet()
	{
		Validate();
	}

	private void Validate()
	{
		validationErrors.Clear();

		if (Event == null)
		{
			validationErrors.Add("Evento no disponible.");
			return;
		}

		if (string.IsNullOrWhiteSpace(Event.Name))
		{
			validationErrors.Add("El nombre del evento no puede estar vacío.");
		}

		if (Event.Date == default || Event.Date == DateTime.MinValue)
		{
			validationErrors.Add("Fecha inválida.");
		}

		if (string.IsNullOrWhiteSpace(Event.Location))
		{
			validationErrors.Add("La ubicación del evento no puede estar vacía.");
		}
	}

	private async Task ViewDetails()
	{
		// Details removed per UX change - kept for backward compatibility but no-op
		await Task.CompletedTask;
	}

	private async Task Register()
	{
		if (!IsValid || Event == null) return;

		if (OnRegister.HasDelegate)
		{
			await OnRegister.InvokeAsync(Event);
			return;
		}

		NavigationManager.NavigateTo($"/events/{Event.Id}/register");
	}

	private int RegisteredCount => Event == null ? 0 : AttendanceService.GetCount(Event.Id);

	private void ViewAttendance()
	{
		if (Event == null) return;
		NavigationManager.NavigateTo($"/events/{Event.Id}/attendance");
	}
}

